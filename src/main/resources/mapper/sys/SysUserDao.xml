<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cxf.modules.sys.dao.SysUserDao">
	
	<!-- 查询用户的所有权限 -->
	<select id="queryAllPerms" resultType="string">
		select m.perms from sys_user_role ur 
			LEFT JOIN sys_role_menu rm on ur.role_id = rm.role_id 
			LEFT JOIN sys_menu m on rm.menu_id = m.menu_id 
		where ur.user_id = #{userId}
	</select>
	
	<!-- 查询用户的所有菜单ID --> 
	<select id="queryAllMenuId" resultType="long">
		select distinct rm.menu_id from sys_user_role ur 
			LEFT JOIN sys_role_menu rm on ur.role_id = rm.role_id 
		where ur.user_id = #{userId}
	</select>
	
	<!-- ユーザネームによって、ユーザー情報を抽出する --> 
	<select id="queryByUserName" resultType="com.cxf.modules.sys.entity.SysUserEntity">
		select * from sys_user where username = #{username} and delete_flag = 0
	</select>
	
	<!-- ユーザーリストを抽出する --> 
	<select id="getUsersByPage" resultType="com.cxf.modules.sys.entity.SysUserEntity">
		SELECT user_id,username,password,salt,email,mobile,status,create_user_id,
		create_time FROM sys_user 
		<choose>
			<when test="userName != null and userName != ''">
				where username = #{userName} and delete_flag = 0
			</when>
			<otherwise>
				where delete_flag = 0
			</otherwise>
		</choose>
		LIMIT #{curPage},#{pageSize}
	</select>
	
	<!-- ユーザー総数を抽出する --> 
	<select id="getCount" parameterType="String" resultType="Integer">
		SELECT COUNT(1) FROM sys_user
		<choose>
			<when test="userName != null and userName != ''">
				where username = #{userName} and delete_flag = 0
			</when>
		</choose>
	</select>
	
	
	<!-- ログインパスワードを更新する -->
	<update id="updatePassword">
		update sys_user set password=#{password} where user_id=#{userId} and delete_flag = 0
	</update>
	
	<!-- ユーザー情報を保存する -->
	<insert id="save" parameterType="com.cxf.modules.sys.entity.SysUserEntity">
		insert into sys_user(username,password,salt,email,mobile,status,create_user_id,create_time) 
		value(#{username}, #{password}, #{salt}, #{email}, #{mobile}, #{status}, #{createUserId}, #{createTime})
	</insert>
	
	<!-- ユーザーを削除する -->
	<update id="removeByIds" parameterType="java.util.List">
		update sys_user set delete_flag=1 where user_id in
		<foreach item="item" index="index" collection="list" open="(" separator="," close=")">
			#{item}
		</foreach>
	</update>
	
	<!-- ユーザーを更新する -->
	<update id="updateUser" parameterType="com.cxf.modules.sys.entity.SysUserEntity">
		update sys_user set username=#{username}, password=#{password}, email=#{email},
		mobile=#{mobile}, salt=#{salt}, status=#{status} , create_user_id=#{createUserId} where user_id=#{userId}
	</update>
</mapper>